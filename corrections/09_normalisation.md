# Corrections — 09. Normalisation (1NF → 3NF)

## Exercice 1 — Problèmes (exemples)

Colonnes qui se répètent :
- infos client (`customer_email`, `customer_name`, `customer_phone`)
- infos produit (`product_sku`, `product_name`, `category_name`, `unit_price`)
- infos d’adresse (`shipping_postal_code`, `shipping_city`, `region_name`)

Anomalies :
- update : changer `product_name` à N endroits
- delete : supprimer la dernière vente d’un produit fait “disparaître” le produit

## Exercice 2 — 1NF

Séparer :
- `orders(order_id, ordered_at, customer_..., shipping_...)`
- `order_items(order_id, product_sku, quantity, unit_price, ...)`

PK :
- `orders.order_id`
- `order_items(order_id, product_sku)`

## Exercice 3 — 2NF

Dans `order_items(order_id, product_sku, ...)` :
- `product_name`, `category_name` dépendent de `product_sku` ⇒ table `products` (+ `categories`)

## Exercice 4 — 3NF

Si `shipping_postal_code -> (shipping_city, region_name)` :
- table `postal_codes(postal_code PK, city, region_name)`
- `orders` garde une FK `shipping_postal_code`

## Exercice 5/6 — Proposition DDL (exemple)

Exemple minimal (idées-clés : séparation des entités + PK/FK + contraintes) :

```sql
CREATE TABLE customers (
  id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  email VARCHAR(255) NOT NULL UNIQUE,
  name VARCHAR(200) NOT NULL,
  phone VARCHAR(30) NULL
);

CREATE TABLE categories (
  id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name VARCHAR(100) NOT NULL UNIQUE
);

CREATE TABLE products (
  id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  category_id INT NOT NULL,
  sku VARCHAR(50) NOT NULL UNIQUE,
  name VARCHAR(200) NOT NULL,
  CONSTRAINT fk_products_category
    FOREIGN KEY (category_id) REFERENCES categories(id)
);

CREATE TABLE postal_codes (
  postal_code VARCHAR(20) PRIMARY KEY,
  city VARCHAR(100) NOT NULL,
  region_name VARCHAR(100) NOT NULL
);

CREATE TABLE orders (
  id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  customer_id INT NOT NULL,
  shipping_postal_code VARCHAR(20) NOT NULL,
  ordered_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_orders_customer
    FOREIGN KEY (customer_id) REFERENCES customers(id),
  CONSTRAINT fk_orders_postal_code
    FOREIGN KEY (shipping_postal_code) REFERENCES postal_codes(postal_code)
);

CREATE TABLE order_items (
  order_id INT NOT NULL,
  product_id INT NOT NULL,
  quantity INT NOT NULL,
  unit_price NUMERIC(10,2) NOT NULL,
  PRIMARY KEY (order_id, product_id),
  CONSTRAINT fk_order_items_order
    FOREIGN KEY (order_id) REFERENCES orders(id),
  CONSTRAINT fk_order_items_product
    FOREIGN KEY (product_id) REFERENCES products(id),
  CONSTRAINT chk_order_items_quantity CHECK (quantity > 0),
  CONSTRAINT chk_order_items_unit_price CHECK (unit_price >= 0)
);
```
